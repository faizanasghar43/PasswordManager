<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/password-view.css"> <!-- Adjust path as necessary -->
    <link rel="stylesheet" href="css/user-menu.css"> <!-- Adjust path as necessary -->
    <title>Password Manager</title>
</head>
<body>

<!-- Password Manager Main UI -->
<div class="navigation">
    <input class="search-bar" type="search" placeholder="Filter Platform & Username">

    <nav class="btn-set1">
        <input class="action-btn logout" type="button" onclick="logout()">
        <input class="action-btn add-record" type="button" onclick="openAddRecord()">
        <input class="action-btn remove-record" type="button" onclick="removeRecord()">
<!--        <input class="action-btn menu-button" type="button" onclick="openUserMenu()">-->
    </nav>

    <nav class="btn-set2">
        <input class="action-btn confirm-delete" type="button" onclick="confirmDelete()">
        <input class="action-btn cancel-delete" type="button" onclick="cancelDelete()">
    </nav>
</div>

<div class="table-container">
   <div id="addRecordModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close-button" onclick="closeModal()">&times;</span>
    <h2>Add New Credential</h2>
    <form id="addCredentialForm">
      <label for="platform">Platform:</label>
      <input type="text" id="platform" name="platform" required>

      <label for="username">Username:</label>
      <input type="text" id="username" name="username" required>

      <label for="password">Password:</label>
      <input type="password" id="password" name="password" required>

      <button type="button" onclick="addCredential()">Add Credential</button>
    </form>
  </div>
</div>


    <table class="styled-table">
        <thead>
        <tr>
            <th class="selection">Selection</th>
            <th>Platform</th>
            <th>Username</th>
            <th>Password</th>
        </tr>
        </thead>
        <tbody>
        <!-- Data will be populated here -->
        </tbody>
    </table>
</div>

<script>
async function getUserData() {
    try {
        const token = localStorage.getItem('token'); // Retrieve the token from local storage
        const response = await fetch('http://localhost:3000/data', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}` // Include the token in the Authorization header
            }
        });
        if (response.ok) {
            const data = await response.json();
            populateTable(data.credentials);
        } else {
            console.error('Error fetching user data:', response.statusText);
            // Optionally, redirect to login page if unauthorized
            if (response.status === 401) {
                window.location.href = 'login.html';
            }
        }
    } catch (error) {
        console.error('Error during getUserData:', error);
    }
}



    function populateTable(credentials) {
        const tbody = document.querySelector('.styled-table tbody');
        tbody.innerHTML = ''; // Clear existing rows

        credentials.forEach((credential) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="selection"><input type="checkbox"></td>
                <td>${credential.service}</td>
                <td>${credential.username}</td>
                <td>
                    <span class="password-display" data-password="${credential.password}">********</span>
                    <span class="eye-icon" onclick="togglePasswordVisibility(this)">üëÅÔ∏è</span>
                    <span class="clipboard-icon" onclick="copyToClipboard('${credential.password}')">üìã</span>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function togglePasswordVisibility(icon) {
        const passwordDisplay = icon.parentElement.querySelector('.password-display');
        const actualPassword = passwordDisplay.getAttribute('data-password');
        passwordDisplay.textContent = passwordDisplay.textContent === '********' ? actualPassword : '********';
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            alert('Password copied to clipboard!');
        }, (err) => {
            console.error('Error copying text to clipboard', err);
        });
    }

    // Call getUserData when the page loads
    window.addEventListener('DOMContentLoaded', (event) => {
        getUserData();
    });

function logout() {
    localStorage.removeItem('userSession');
    window.location.href = 'login.html';
}
function openAddRecord() {
    document.getElementById('addRecordModal').style.display = 'block';
}
function removeRecord() {
    // This would be triggered by selecting records to delete, typically using checkboxes
    const checkboxes = document.querySelectorAll('.selection input[type="checkbox"]:checked');
    checkboxes.forEach(checkbox => {
        checkbox.closest('tr').classList.add('marked-for-deletion');
    });
    // Show delete confirmation buttons
    document.querySelector('.btn-set2').style.display = 'block';
}
function confirmDelete() {
    const markedRecords = document.querySelectorAll('.marked-for-deletion');
    markedRecords.forEach(record => {
        const service = record.querySelector('td:nth-child(2)').textContent;
        // Assuming you have a function to call your API to delete the record
        deleteRecord(service); // Implement this function based on your API
        record.remove(); // Remove the record from the table
    });
    document.querySelector('.btn-set2').style.display = 'none'; // Hide confirmation buttons
}
function cancelDelete() {
    const markedRecords = document.querySelectorAll('.marked-for-deletion');
    markedRecords.forEach(record => {
        record.classList.remove('marked-for-deletion');
    });
    document.querySelector('.btn-set2').style.display = 'none'; // Hide confirmation buttons
}
// async function addCredential() {
//     const platform = document.getElementById('platform').value;
//     const username = document.getElementById('username').value;
//     const password = document.getElementById('password').value;
//
//     // Assuming you have an API endpoint '/add-credential' that accepts POST requests
//     const response = await fetch('/add-credential', {
//         method: 'POST',
//         headers: {
//             'Content-Type': 'application/json',
//             // Include authorization header if your API requires authentication
//         },
//         body: JSON.stringify({ platform, username, password }),
//     });
//
//     if (response.ok) {
//         alert('Credential added successfully!');
//         document.getElementById('addRecordModal').style.display = 'none';
//         getUserData(); // Refresh the data displayed on the page
//     } else {
//         alert('Failed to add credential. Please try again.');
//     }
// }
async function addCredential() {
    const userId = 2; // Assuming userID is stored in localStorage
    const platform = document.getElementById('platform').value;
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;

    const response = await fetch(`/user/${userId}/credentials`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ service: platform, username, password }),
    });

    if (response.ok) {
        alert('Credential added successfully!');
        document.getElementById('addRecordModal').style.display = 'none';
        getUserData(); // Refresh the data displayed on the page
    } else {
        const errorText = await response.text();
        alert(`Failed to add credential: ${errorText}`);
    }
}


</script>
</body>
</html>
